<?php

namespace App\Prompts;

class RissPrompts
{
  private const SYSTEM_CONTEXT = "あなたは、情報処理安全確保支援士（RISS）の午後試験対策を専門とする高度な学習指導AIトレーナーです。";

  /**
   * AI演習モード用の問題生成プロンプト
   */
  public static function getGeneratePrompt(array $context): string
  {
    $systemContext = self::SYSTEM_CONTEXT;
    return <<<PROMPT
{$systemContext}
IPAの情報処理安全確保支援士 午後試験を模した、**「技術キーワード主導型」のケーススタディ問題**を1問作成してください。
「問題文の特定の下線部」と「設問」の対応関係を厳密にし、論理的整合性の高い良問を作成することが目的です。

### 問題作成アルゴリズム
1. **核となる技術キーワード（アンカー）の選定**:
   - まず、設問のターゲットとする「具体的な技術用語、設定値、プロトコル要素」を1つ決定してください。
   - 例：`CSRF対策用トークン`, `Set-CookieヘッダーのSameSite属性`, `OAuthのstateパラメータ`, `JWTの署名アルゴリズム` 等。
2. **シナリオの構築**:
   - 上記キーワードに関連する「脆弱性」または「不備」を含むシステム環境を1,000文字程度で記述してください。
   - そのキーワードが登場する箇所に必ず「<u>下線(1)</u>」を付与してください。
3. **設問の設計（すべてアンカーに関連付ける）**:
   - **設問1（用語）**: 下線(1)に関連する「攻撃名」や「正しい技術用語」を答えさせる。
   - **設問2（論理推論）**: 下線(1)の状態が「なぜ脆弱なのか」または「どのような脅威があるか」を、本文の文脈に沿って30〜50位文字程度で説明させる。
   - **設問3（対策）**: 下線(1)の箇所を「どのように修正・設定すべきか」を、試験で求められる具体的な表現で答えさせる。

### 重点テーマ（以下から1つ以上を要素として含む）
- ディレクトリトラバーサル, CSRF, セッション固定, OSコマンド注入, パスワードリスト攻撃, SAML/OAuth不備, API脆弱性, WAF/IDSの検知不備, 認可制御エラー。

### 出力構成
1. **【テーマ】**: 作成した問題の核となるキーワード。
2. **【問題文】**: IPA試験特有の硬派なトーン（図解はテキスト形式、Mermaid不可）。
3. **【設問】**: 設問1〜3。

### 制約
- 設問の正解が「本文の文脈」から逸脱しないようにしてください。
- 受験者が本文を読めば、論理的に正解に辿り着ける構成にしてください。

【対象分野】
分野：{$context['category']} / {$context['subcategory']}

実務的かつ試験対策として精度の高い問題を出力してください。
PROMPT;
  }

  /**
   * 採点用プロンプト（過去問・AI生成共通）
   */
  public static function getScorePrompt(string $exerciseText, string $userAnswer, array $context): string
  {
    $systemContext = self::SYSTEM_CONTEXT;
    return <<<PROMPT
{$systemContext}
以下の演習問題に対する受験者の解答を、IPAの「採点講評」の基準に準拠して厳格かつ建設的に採点してください。

**採点ロジック（キーワード加点方式）**:
1. **必須キーワード**: 正解に含まれるべき重要な技術用語や概念が含まれているか。
2. **論理構成**: 設問の意図（「なぜ」「どのように」）に対して、問題文の文脈に沿った論理的な回答になっているか。
3. **制約遵守**: 文字数制限や「記号で答えよ」などの指示を守っているか。

**フィードバックのトーン**:
IPAの試験センターが公表する「採点講評」のような、客観的で受験者の気づきを促すトーンで記述してください（例：「〜という記述が欲しかった」「〜という点は正しく理解できている」）。

【演習問題】
{$exerciseText}

【受験者解答】
{$userAnswer}

【出力形式】
点数：0〜100
■良い点
...
■不足している点・改善のアドバイス
...
■この問題の正解のポイント（IPA採点基準に準拠）
...
■模範解答
...
PROMPT;
  }
}

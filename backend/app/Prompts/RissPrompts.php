<?php

namespace App\Prompts;

class RissPrompts
{
  private const SYSTEM_CONTEXT = "あなたは、情報処理安全確保支援士（RISS）の午後試験対策を専門とする高度な学習指導AIトレーナーです。";

  /**
   * AI演習モード用の問題生成プロンプト
   */
  public static function getGeneratePrompt(array $context): string
  {
    $systemContext = self::SYSTEM_CONTEXT;
    return <<<PROMPT
{$systemContext}
IPAの情報処理安全確保支援士（RISS）試験の**午後II試験レベル**に相当する、実践的な「キーワード空欄補充・記述型」のケーススタディ問題を作成してください。
あなたのタスクは、公表されている過去問のトーン・文体、および設問の論理構成を完全に再現し、受験者の「本番対応力」を養える良問を生成することです。

### 1. 執筆ガイドライン（IPA流儀の徹底）
- **空欄形式 [  a  ] の採用**: アンカーキーワード（過去問実績のある用語）が入る箇所を `[  a  ]` の空欄形式にし、前後に技術的ヒントを記述してください。
- **下線の記法（重要）**: 
  - 下線を示す際は「下線(1)」という文字は書かずに、**「<u>①対象フレーズ</u>」**のように、丸数字を先頭に置いてその後に下線部を続けてください。
  - 下線は、設問の対象となる「不備のある設計内容」や「問題のある挙動」を表す文全体、またはフレーズ全体を確実に囲むようにしてください。
- **設問の記法**: 設問文の中では「下線①」といった形で参照してください。
- **設問2・3の過去問準拠**: 実際の試験での「回答の根拠」や「論理の組み立て」を忠実に再現し、IPA特有の問い方を踏襲してください。
- **シナリオの凝縮**: 合計500〜700文字程度で構成してください。
- **固有名詞の排除**: 「A社」「Kクラウド」等の伏せ字表現を徹底してください。

### 2. シナリオ構成
セクションタイトルは「〔 〕」を使い、以下の構成にしてください。

〔 A社の概要とシステム構成 〕
〔 問題の核心：脆弱性または不備 〕
- 空欄 `[  a  ]` および、不備のある挙動を示す文全体を囲んだ `<u>①対象フレーズ</u>` を含む記述。
〔 調査の経緯と現状 〕

### 3. 設問の設計
1. （空欄 [  a  ] に入る適切な技術用語または攻撃名を答えさせる）
2. （下線①がもたらす技術的脅威を、40文字以内で答えさせる）
3. （本文の制約を踏まえ、[  a  ] への対策を答えさせる）

### 4. 出力フォーマット（厳守）
〔問題〕
（500〜700文字の試験文面）

〔設問〕
1. （空欄補充の設問）
2. （下線①についての記述設問：40文字以内）
3. （対策設問）

### 5. 制約
- 分野：{$context['category']} / {$context['subcategory']}
PROMPT;
  }

  /**
   * 採点用プロンプト（過去問・AI生成共通）
   */
  public static function getScorePrompt(string $exerciseText, string $userAnswer, array $context): string
  {
    $systemContext = self::SYSTEM_CONTEXT;
    $sampleAnswersPart = "";
    if (!empty($context['sample_answers'])) {
      $sampleAnswersPart = "\n【模範解答（公式・参考）】\n";
      foreach ($context['sample_answers'] as $ans) {
        $sampleAnswersPart .= "問{$ans['question_number']} 設問{$ans['section_id']} ({$ans['item_id']}): {$ans['answer_text']}\n";
        if (!empty($ans['explanation'])) {
          $sampleAnswersPart .= "  解説: {$ans['explanation']}\n";
        }
      }
    }

    return <<<PROMPT
{$systemContext}
以下の演習問題に対する受験者の解答を、IPAの「採点講評」の基準に準拠して厳格かつ建設的に採点してください。
{$sampleAnswersPart}

**採点ロジック（キーワード加点方式）**:
1. **必須キーワード**: 正解に含まれるべき重要な技術用語や概念が含まれているか。模範解答がある場合は、そのキーワードが含まれているか厳密にチェックしてください。
2. **論理構成**: 設問の意図（「なぜ」「どのように」）に対して、問題文の文脈に沿った論理的な回答になっているか。
3. **制約遵守**: 文字数制限や「記号で答えよ」などの指示を守っているか。

**フィードバックのトーン**:
IPAの試験センターが公表する「採点講評」のような、客観的で受験者の気づきを促すトーンで記述してください（例：「〜という記述が欲しかった」「〜という点は正しく理解できている」）。

【演習問題】
{$exerciseText}

【受験者解答】
{$userAnswer}

【出力形式】
点数：0〜100
■良い点
...
■不足している点・改善のアドバイス
...
■この問題の正解のポイント（IPA採点基準に準拠）
...
■模範解答
PROMPT;
  }


  /**
   * 抽出済みのテキストから設問構造を整理するためのプロンプト
   */
  public static function getAnalyzeFromTextPrompt(): string
  {
    return <<<PROMPT
# 背景
あなたは情報処理技術者試験（特に情報処理安全確保支援士）の「問題冊子」を解析するエキスパートです。
提供された「文字起こし済みテキスト」を読み取り、試験問題の構造（問・設問・項目）を整理して解答フォームに必要な情報を抽出してください。

# 抽出のルール
1.  **全文の把握**: 提供されたテキストはOCRの結果であるため、誤字脱字がある可能性があります。文脈から「問(Question)」「設問(Section)」「項目(Item)」を特定してください。
2.  **構造化**: 問題を「階層構造（JSON）」で整理してください。
3.  **解答項目(Item)の特定**: 
    - 空欄 `[ a ]` や、`(1)` などの解答が必要な箇所を `item` として抽出します。
    - 文字数制限（「20字以内」など）があれば必ず抽出してください。
4.  **模範解答の暫定案**:
    - テキストから考えられる**模範解答の暫定案**を出力してください。

# 出力フォーマット (JSON)
必ず以下の階層構造を持つJSON形式で返してください。

{
  "questions": [
    {
      "question_number": 1,
      "title": "問1 情報セキュリティシステムの構築",
      "sections": [
        {
          "section_id": "1",
          "section_text": "本文中の空欄 [ a ] 〜 [ c ] に入れる適切な字句を答えよ。",
          "items": [
            { "item_id": "a", "item_text": "空欄 [ a ]", "char_limit": 10, "answer_type": "text", "sample_answer": "正解候補1" }
          ]
        }
      ]
    }
  ]
}

有効なJSONオブジェクトのみを返し、前後の説明は一切不要です。
PROMPT;
  }

  /**
   * 解答・講評PDFのテキストから模範解答データを抽出するためのプロンプト
   */
  public static function getExtractAnswersPrompt(): string
  {
    return <<<PROMPT
# 背景
あなたは情報処理安全確保支援士試験の「解答例」および「講評」を解析するAIです。
提供されたテキストデータから、各設問ごとの「模範解答」と「解説（講評）」を抽出し、指定のJSON形式で出力してください。

# 入力データ
- 試験の「解答例」PDFまたは「講評」PDFから抽出されたテキスト

# 抽出ルール
1. **問題単位の識別**: "問1", "問2" などの区切りを見つけ、問題ごとにデータをまとめてください。
2. **設問・項目の識別**: "設問1", "設問2", "(1)", "(2)", "a", "b" などの階層構造を正確に捉えてください。
3. **解答テキスト**: 解答例として記載されている文言をそのまま抽出してください。
4. **解説・講評**: もし「講評」のテキストが含まれている場合、その設問に対する解説や重要ポイントとして抽出してください。講評がない場合は空文字で構いません。

# 出力フォーマット (JSON)
[
  {
    "question_number": 1,
    "sections": [
      {
        "section_id": "1",
        "items": [
          {
            "item_id": "a",
            "answer_text": "解答例のテキスト",
            "explanation": "講評などから得られる解説（あれば）"
          }
        ]
      }
    ]
  },
  {
    "question_number": 2,
    ...
  }
]

# 制約
- 必ず有効なJSON配列を返してください。
- JSON以外の説明文は含めないでください。
PROMPT;
  }
}

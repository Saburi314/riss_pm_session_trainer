<?php

namespace App\Services;

class PromptService
{
    /**
     * RISS 試験範囲に基づく階層型カテゴリ定義
     */
    public const CATEGORIES = [
        'MGT' => [
            'category' => '情報セキュリティマネジメントの推進または支援に関すること',
            'subcategories' => [
                'policy' => '情報セキュリティ方針の策定',
                'risk_assessment' => '情報セキュリティリスクアセスメント',
                'risk_response' => '情報セキュリティリスク対応',
                'regulations' => '情報セキュリティ諸規定の策定',
                'audit' => '情報セキュリティ監査',
                'trends' => '情報セキュリティに関する動向・事例の収集と分析',
                'communication' => '関係者とのコミュニケーション',
            ],
        ],
        'SYS' => [
            'category' => '情報システムの企画・設計・開発・運用でのセキュリティ確保の推進又は支援に関する事',
            'subcategories' => [
                'planning' => '企画・要件定義（セキュリティの観点）',
                'deployment' => '製品・サービスのセキュアな導入',
                'architecture' => 'アーキテクチャの設計（セキュリティの観点）',
                'implementation' => 'セキュリティ機能の設計・実装',
                'programming' => 'セキュアプログラミング',
                'testing' => 'セキュリティテスト',
                'maintenance' => '運用・保守（セキュリティの観点）',
                'dev_env' => '開発環境のセキュリティ確保',
            ],
        ],
        'OPS' => [
            'category' => '情報及び情報システムの利用におけるセキュリティ対策の適用の推進又は支援に関すること',
            'subcategories' => [
                'crypto' => '暗号利用及び鍵管理',
                'malware' => 'マルウェア対策',
                'backup' => 'バックアップ',
                'monitoring' => 'セキュリティ監視並びにログの取得及び分析',
                'network' => 'ネットワークおよび機器のセキュリティ管理',
                'vulnerability' => '脆弱性への対応',
                'physical' => '物理的セキュリティ管理',
                'account' => 'アカウント管理及びアクセス管理',
                'human' => '人的管理',
                'supply_chain' => 'サプライチェーンの情報セキュリティの推進',
                'compliance' => 'コンプライアンス管理',
            ],
        ],
        'INC' => [
            'category' => '情報セキュリティインシデント管理の推進又は支援に関すること',
            'subcategories' => [
                'org' => '情報セキュリティインシデントの管理体制の構築',
                'assessment' => '情報セキュリティ事象の評価',
                'response' => '情報セキュリティインシデントへの対応',
                'evidence' => '証拠の収集及び分析',
            ],
        ],
    ];

    public function buildGeneratePrompt(?string $category, ?string $subcategory): string
    {
        $context = $this->getCategoryDisplayNames($category, $subcategory);

        return <<<PROMPT
{$this->getSystemContextPrompt()}
情報処理安全確保支援士の午後試験に基づいた「演習問題」を、以下の条件で1問作成してください。
作成にあたっては、まず **file_search を用いて実際の午後試験問題（過去問）を検索**し、その文体、難易度、および設問の構成を十分に分析した上で、本物の試験と区別がつかないレベルのクオリティで出力してください。
全ての設問には必ず、問題文中にヒントを散りばめてください。問題文を読み解くことで必ず解答にたどり着けるようにしてください。すべての設問は、過去問での問題文中や解答に利用された内容を設問として問うようにしてください。

**重要項目**:
- **冒頭・末尾のメタ情報排除**: 【問題文】の冒頭（「本問は〜」）や、演習の最後に付随する「注記」「解説」「出典の傾向」といった説明的な文章は一切入れず、試験問題のコンテンツのみを出力してください。
問題文中でのメタ情報は一切不要です。
- **図・表・コードの管理（最重要・記法厳守）**: 
  - **原則として、すべての要素は標準的なMarkdown記法で記述してください。**
  - **図（システム構成図等）**: 
    - 「図1: ○○」のようなタイトルを **プレーンテキストで記述し、その直後に改行してから** ` ```mermaid ` ブロックを開始してください。
    - **ブロック内は `flowchart TD` 等の宣言から開始し、説明文は一切含めないでください。**
    - **重要**: 日本語や記号を含むテキストは、必ず `id["テキスト"]` のように **ダブルクォーテーションで囲んで** ください（例: `A["Webサーバ"] --> B["DBサーバ"]`）。これを守らないとエラーになります。
  - **表**: 「表1: ○○の設定」のようなタイトルの後に、必ず `|` を使用した**Markdown構成のテーブル**で記述してください。
  - **ソースコード**: 「図n: ○○」のようなタイトルの後に、必ず ` ```言語名 ` ブロック（例：` ```java `）で囲んで記述してください。
  - **共通ルール**: 各タイトルの前後には必ず **2行の空行** を挿入し、視認性を確保してください。

【分野】
大分類：{$context['category']}
小分類：{$context['subcategory']}

【基本構成】
1. **問題文**: 1000〜1500字程度。詳細で正確なシナリオを記述してください。
   - **下線と番号**: 設問で参照する箇所のみ、文章全体ではなく対象となる短いフレーズのみ を `<u>...</u>` で囲み、その直前に番号を付与してください（例：`①<u>パスワードのハッシュ化</u>`）。
   - **整合性とシーケンシャル性（最重要）**: 
     - 下線番号は、**問題文を上から読み進めた際に現れる順に、必ず ①, ②, ③ と昇順で番号を振ってください。**
     - 番号の飛びや逆転は絶対にしないでください。
     - 設問で使われない「余分な下線」は絶対に引かないでください。
   - **穴埋めの目立たせ（最重要）**: 
     - 本文中の穴埋め: **［ a ］** （全角ブラケット＋全角スペース）
     - 図・表・コード中の穴埋め: **[ b ]** （半角ブラケット＋スペース）
   - **ヒントの強化**: 穴埋め箇所の用語を特定できるよう、その用語の定義や具体的な役割を説明する文章（ヒント）を必ず周辺に含めてください。
   - **関連性の徹底**: 問題文中の叙述、図、表、ソースコードは、必ずいずれかの設問を解くために必要な情報として構成してください。

2. **設問**: **必ず以下の5問**をこの順番で作成してください。以下の形式例に従ってください。

   - **(1)**: 本文中の穴埋め **［ a ］** に関する問題。rissで出題されうるセキュリティ用語を答える問題であり、過去問での問題文中や解答に利用された語句を問う。
     - 例: 「本文中の **［ a ］** に入れる適切な字句を、10字以内で答えよ。」

   - **(2)**: 本文最初の **下線①** に関する選択問題。
     - **出力形式（厳守）**: 設問文の直後に改行し、インデントして「解答群」と記述し、その下行から選択肢を1行ずつ列挙。
     - 例：
       (2) 本文中の下線①について、最も適切なものはどれか。記号で答えよ。
        　解答群
        　ア　管理者権限を持つユーザのみがアクセスできる。
        　イ　全てのユーザが読み取り権限を持つ。
        　ウ　...

   - **(3)**: 図・表・ソースコード内の穴埋め **[ b ]** 等に関する問題。ヒントとなる記述が問題文中に存在していることを確認すること。過去問での問題文中や解答に利用された語句を問う。
     - 例: 「図1中の **[ b ]** に入れる適切な字句を答えよ。」
     - 例: 「表1中の **[ b ]** に入れる適切な字句を答えよ。」

   - **(4)**: 本文2番目の **下線②** に関する記述問題（理由や仕組み）。
     - 例: 「本文中の下線②において、○○するのはなぜか。その理由を30字以内で答えよ。」
     - 例: 「本文中の下線②について、○○を20字以内で答えよ。」

   - **(5)**: 本文3番目の **下線③** に関する・記述問題（対策や手法）。
     - 例: 「本文中の下線③の対策として、有効な対策を具体的に答えよ。」
     - 例: 「本文中の下線③について、○○である理由を具体的に答えよ。」


【出力形式】
【問題文】
（ここに必ず1行空行を入れてから、本文を開始してください。シナリオ、図、表、コードを適宜挿入し、各要素の前後には必ず2行の空行を入れてください）

【設問】
（ここに必ず1行空行を入れてから、開始してください）
(1) ...
(2) ...
(3) ...
(4) ...
(5) ...
PROMPT;
    }

    public function buildScorePrompt(string $exerciseText, string $userAnswer, ?string $category, ?string $subcategory): string
    {
        $context = $this->getCategoryDisplayNames($category, $subcategory);

        return <<<PROMPT
{$this->getSystemContextPrompt()}
提示された「演習問題」に対する「受験者の解答」を厳格、かつ建設的に採点し、詳細な講評を行ってください。

【分野背景】大分類：{$context['category']} / 小分類：{$context['subcategory']}

【採点時の留意事項】
- **テキストベースの回答**: 受験者はテキストエリアに文字のみで回答しています。図や表を描くことはできません。
- **(5) 具体的回答問題の採点**: この設問は自由度が高いため、あまりに厳格すぎる減点は避け、論理的な整合性と必須キーワードが含まれているかを重視してください。
- **建設的なフィードバック**: 単なる正誤だけでなく、どう考えれば正解に辿り着けたかのヒントを提示してください。

【指示】
1. **基準の確認**: file_search で当該分野の過去問の配点箇所、採点講評を検索し、IPAが重視する正解のポイント（キーワード、論理構成）を特定してください。
2. **用語の正確性**: 採点およびアドバイスにおいて、IPA公式の用語を正しく使用してください。
3. **客観的な採点**: 解答が設問の制約（文字数や必須語句）を満たしているか、状況設定と矛盾していないかを判定してください。

【出力形式】
点数：0〜100
■良い点
...
■不足している点・改善のアドバイス
...
■この問題の正解のポイント（IPAの採点基準に準拠）
...
■模範解答
...

【対象データ】
【演習問題】
{$exerciseText}

【受験者解答】
{$userAnswer}
PROMPT;
    }

    private function getCategoryDisplayNames(?string $categoryKey, ?string $subcategoryKey): array
    {
        $categoryLabel = '全般（ランダム）';
        $subcategoryLabel = '全般（ランダム）';

        if ($categoryKey && isset(self::CATEGORIES[$categoryKey])) {
            $categoryLabel = self::CATEGORIES[$categoryKey]['category'];
            if ($subcategoryKey && isset(self::CATEGORIES[$categoryKey]['subcategories'][$subcategoryKey])) {
                $subcategoryLabel = self::CATEGORIES[$categoryKey]['subcategories'][$subcategoryKey];
            }
        }

        return ['category' => $categoryLabel, 'subcategory' => $subcategoryLabel];
    }

    private function getSystemContextPrompt(): string
    {
        return "あなたは、情報処理安全確保支援士（RISS）の午後試験対策を専門とする高度な学習指導AIトレーナーです。";
    }
}

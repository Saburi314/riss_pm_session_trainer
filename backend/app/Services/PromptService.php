<?php

namespace App\Services;

class PromptService
{
    /**
     * RISS 試験範囲に基づく階層型カテゴリ定義
     */
    public const CATEGORIES = [
        'MGT' => [
            'label' => '情報セキュリティマネジメントの推進または支援に関すること',
            'minors' => [
                'policy' => '情報セキュリティ方針の策定',
                'risk_assessment' => '情報セキュリティリスクアセスメント',
                'risk_response' => '情報セキュリティリスク対応',
                'regulations' => '情報セキュリティ諸規定の策定',
                'audit' => '情報セキュリティ監査',
                'trends' => '情報セキュリティに関する動向・事例の収集と分析',
                'communication' => '関係者とのコミュニケーション',
            ],
        ],
        'SYS' => [
            'label' => '情報システムの企画・設計・開発・運用でのセキュリティ確保の推進又は支援に関する事',
            'minors' => [
                'planning' => '企画・要件定義（セキュリティの観点）',
                'deployment' => '製品・サービスのセキュアな導入',
                'architecture' => 'アーキテクチャの設計（セキュリティの観点）',
                'implementation' => 'セキュリティ機能の設計・実装',
                'programming' => 'セキュアプログラミング',
                'testing' => 'セキュリティテスト',
                'maintenance' => '運用・保守（セキュリティの観点）',
                'dev_env' => '開発環境のセキュリティ確保',
            ],
        ],
        'OPS' => [
            'label' => '情報及び情報システムの利用におけるセキュリティ対策の適用の推進又は支援に関すること',
            'minors' => [
                'crypto' => '暗号利用及び鍵管理',
                'malware' => 'マルウェア対策',
                'backup' => 'バックアップ',
                'monitoring' => 'セキュリティ監視並びにログの取得及び分析',
                'network' => 'ネットワークおよび機器のセキュリティ管理',
                'vulnerability' => '脆弱性への対応',
                'physical' => '物理的セキュリティ管理',
                'account' => 'アカウント管理及びアクセス管理',
                'human' => '人的管理',
                'supply_chain' => 'サプライチェーンの情報セキュリティの推進',
                'compliance' => 'コンプライアンス管理',
            ],
        ],
        'INC' => [
            'label' => '情報セキュリティインシデント管理の推進又は支援に関すること',
            'minors' => [
                'org' => '情報セキュリティインシデントの管理体制の構築',
                'assessment' => '情報セキュリティ事象の評価',
                'response' => '情報セキュリティインシデントへの対応',
                'evidence' => '証拠の収集及び分析',
            ],
        ],
    ];

    public function buildGeneratePrompt(?string $major, ?string $minor): string
    {
        $context = $this->resolveCategoryLabels($major, $minor);

        return <<<PROMPT
{$this->getSystemContextPrompt()}
情報処理安全確保支援士の午後試験に基づいた「演習問題」を、以下の条件で1問作成してください。
作成にあたっては、まず **file_search を用いて実際の午後試験問題（過去問）を検索**し、その文体、難易度、および設問の構成を十分に分析した上で、本物の試験と区別がつかないレベルのクオリティで出力してください。

**重要項目**:
- **冒頭・末尾のメタ情報排除**: 【問題文】の冒頭（「本問は〜」）や、演習の最後に付随する「注記」「解説」「出典の傾向」といった説明的な文章は一切入れず、試験問題のコンテンツのみを出力してください。
- **図・表・コードの管理**: 
  - **必ず「図1: ○○の構成」「表1: ○○の設定」といった通し番号とタイトルを付与してください。ソースコードについても「図2: ○○のプログラム」のように「図」として扱い、タイトルを付記してください。**
  - タイトルは太字にせず、プレーンなテキストで記述してください。
  - 図（Mermaid）、表、コードブロックの前後には必ず **2行の空行** を挿入してください。

【分野】
大項目：{$context['major']}
小項目：{$context['minor']}

【基本構成】
1. **問題文**: 800〜1500字程度。詳細で正確なシナリオを記述してください。
   - **下線と番号**: 設問で参照する箇所のみ、文章全体ではなく対象となる短いフレーズのみ を `<u>...</u>` で囲み、その直前に番号を付与してください（例：`①<u>パスワードのハッシュ化</u>`）。
   - **整合性とシーケンシャル性（最重要）**: 
     - 下線番号は、**問題文を上から読み進めた際に現れる順に、必ず ①, ②, ③, ④ と昇順で番号を振ってください。**
     - 番号の飛びや逆転は絶対にしないでください。
     - 設問で使われない「余分な下線」は絶対に引かないでください。
   - **穴埋めの目立たせ（最重要）**: 穴埋め箇所 ［ a ］ は、必ず太字を使用して **［  a  ］** と記述してください。前後には全角スペースを入れ、視認性を高めてください（例：`**［  a  ］**`）。
   - **ヒントの強化**: 穴埋め箇所の用語を特定できるよう、その用語の定義や具体的な役割を説明する文章（ヒント）を必ず周辺に含めてください。
   - **関連性の徹底**: 問題文中の叙述、図、表、ソースコードは、必ずいずれかの設問を解くために必要な情報として構成してください。

2. **設問**: **必ず以下の5問**をこの順番で作成してください。
   - **(1)**: 本文中の **［  a  ］** に当てはめる適切な用語を答えさせる。
   - **(2)**: 本文最初の **下線①** について判断を選択させる。設問の直後に **全角スペース等で一段下げて** 「ア〜エ」の選択肢を列挙してください。
   - **(3)**: 本文2番目の **下線②** について分析させる。
     *※問題文中にソースコード（図）が含まれる場合は、必ずそのコードの内容を具体的に分析し、問いに答える形式にしてください。*
   - **(4)**: 本文3番目の **下線③** の理由や仕組みを問う。「〜40文字以内で答えよ。」のように文字数制限を付与してください。
   - **(5)**: 本文4番目の **下線④** に基づく総合的な対策。末尾は 「〜具体的に答えよ。」 または 「〜具体的に述べよ。」 としてください。

【出力形式】
【問題文】
...（シナリオ、図、表、コードを統合）

【設問】
(1) ...
(2) ...
(3) ...
(4) ...
(5) ...
PROMPT;
    }

    public function buildScorePrompt(string $exerciseText, string $userAnswer, ?string $major, ?string $minor): string
    {
        $context = $this->resolveCategoryLabels($major, $minor);

        return <<<PROMPT
{$this->getSystemContextPrompt()}
提示された「演習問題」に対する「受験者の解答」を厳格、かつ建設的に採点し、詳細な講評を行ってください。

【分野背景】{$context['major']} / {$context['minor']}

【採点時の留意事項】
- **テキストベースの回答**: 受験者はテキストエリアに文字のみで回答しています。図や表を描くことはできません。
- **(5) 具体的回答問題の採点**: この設問は自由度が高いため、あまりに厳格すぎる減点は避け、論理的な整合性と必須キーワードが含まれているかを重視してください。
- **建設的なフィードバック**: 単なる正誤だけでなく、どう考えれば正解に辿り着けたかのヒントを提示してください。

【指示】
1. **基準の確認**: file_search で当該分野の過去問の配点箇所、採点講評を検索し、IPAが重視する正解のポイント（キーワード、論理構成）を特定してください。
2. **用語の正確性**: 採点およびアドバイスにおいて、IPA公式の用語を正しく使用してください。
3. **客観的な採点**: 解答が設問の制約（文字数や必須語句）を満たしているか、状況設定と矛盾していないかを判定してください。

【出力形式】
点数：0〜100
■良い点
...
■不足している点・改善のアドバイス
...
■この問題の正解のポイント（IPAの採点基準に準拠）
...
■模範解答
...

【対象データ】
【演習問題】
{$exerciseText}

【受験者解答】
{$userAnswer}
PROMPT;
    }

    private function resolveCategoryLabels(?string $major, ?string $minor): array
    {
        $majorLabel = '全般（ランダム）';
        $minorLabel = '全般（ランダム）';

        if ($major && isset(self::CATEGORIES[$major])) {
            $majorLabel = self::CATEGORIES[$major]['label'];
            if ($minor && isset(self::CATEGORIES[$major]['minors'][$minor])) {
                $minorLabel = self::CATEGORIES[$major]['minors'][$minor];
            }
        }

        return ['major' => $majorLabel, 'minor' => $minorLabel];
    }

    private function getSystemContextPrompt(): string
    {
        return "あなたは、情報処理安全確保支援士（RISS）の午後試験対策を専門とする高度な学習指導AIトレーナーです。";
    }
}
